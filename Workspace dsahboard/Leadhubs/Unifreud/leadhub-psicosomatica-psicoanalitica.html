<!-- LEADHUB: PSICOSOM√ÅTICA PSICOANAL√çTICA -->
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Inter', sans-serif;
    }
</style>

<div class="w-full">
    <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">Psicosom√°tica Psicoanal√≠tica</h1>
                <span
                    class="px-3 py-1 rounded-full text-xs font-bold bg-indigo-100 text-indigo-700 border border-indigo-200 uppercase tracking-wide">LeadHub</span>
            </div>
            <p class="text-slate-500 text-sm">Gestiona y da seguimiento a todos tus leads de UNIFREUD en tiempo real.
            </p>
        </div>
        <div class="flex gap-3">
            <button onclick="exportTableToCSV()"
                class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-slate-600 text-sm font-bold hover:bg-slate-50 transition-colors flex items-center gap-2"><span>üì•</span>
                Exportar CSV</button>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Total Leads</p>
            <div class="flex items-end justify-between"><span id="stat-total-leads"
                    class="text-3xl font-extrabold text-slate-900">-</span></div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Leads Hoy</p>
            <div class="flex items-end justify-between"><span id="stat-leads-today"
                    class="text-3xl font-extrabold text-slate-900">-</span></div>
        </div>
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">√öltimos 7 D√≠as</p>
            <div class="flex items-end justify-between"><span id="stat-last-7-days"
                    class="text-3xl font-extrabold text-slate-900">-</span></div>
        </div>
    </div>

    <div class="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 mb-6 flex flex-col md:flex-row gap-4">
        <div class="relative flex-grow">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">üîç</span>
            <input id="search-input" type="text" placeholder="Buscar por nombre, email, tel√©fono..."
                class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 bg-slate-50 text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all"
                onkeyup="handleSearch()">
        </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="bg-slate-50 border-b border-gray-100">
                        <th class="text-left py-4 px-6 text-xs font-bold text-slate-400 uppercase tracking-wider">Nombre
                        </th>
                        <th class="text-left py-4 px-6 text-xs font-bold text-slate-400 uppercase tracking-wider">
                            Tel√©fono</th>
                        <th class="text-left py-4 px-6 text-xs font-bold text-slate-400 uppercase tracking-wider">Correo
                        </th>
                        <th class="text-left py-4 px-6 text-xs font-bold text-slate-400 uppercase tracking-wider">
                            Servicio</th>
                        <th class="text-left py-4 px-6 text-xs font-bold text-slate-400 uppercase tracking-wider">
                            Fecha_Hora</th>
                        <th class="text-left py-4 px-6 text-xs font-bold text-slate-400 uppercase tracking-wider">Estado
                        </th>
                    </tr>
                </thead>
                <tbody id="leads-table-body" class="divide-y divide-gray-50"></tbody>
            </table>
        </div>
        <div id="pagination-container" class="p-4 border-t border-gray-100 flex items-center justify-between"></div>
    </div>
</div>

<script>
    const BASE_API_URL = "https://script.google.com/macros/s/AKfycbwMQMAbBf54Z4jm7-I7l3Wibxj-7hs8aMa7e4XRsudLuMVQ-3oplxEcKD_3qRSQghPS/exec";
    const SHEET_TAB_NAME = "Psicosomatica Psicoanalitica";
    const API_URL = `${BASE_API_URL}?sheet=${encodeURIComponent(SHEET_TAB_NAME)}`;

    const TABLE_BODY_ID = "leads-table-body", ITEMS_PER_PAGE = 10;
    let allLeads = [], filteredLeads = [], currentPage = 1;
    const tableBody = document.getElementById(TABLE_BODY_ID), searchInput = document.getElementById("search-input"), paginationContainer = document.getElementById("pagination-container");

    document.addEventListener("DOMContentLoaded", () => { fetchLeads(); });

    async function fetchLeads() {
        renderLoading(); try {
            const response = await fetch(API_URL), data = await response.json();
            if (data.status === "error") { renderError(data.message); return; }
            if (!data || data.length === 0) { renderEmpty(); updateStats([]); return; }
            allLeads = data; filteredLeads = [...allLeads]; updateStats(allLeads); renderPage(1);
        } catch (error) { renderError("Error de conexi√≥n."); }
    }

    function renderPage(page) {
        currentPage = page;
        const start = (page - 1) * ITEMS_PER_PAGE, end = start + ITEMS_PER_PAGE, leadsToShow = filteredLeads.slice(start, end);
        tableBody.innerHTML = ""; leadsToShow.length === 0 ? renderEmpty() : leadsToShow.forEach(l => renderRow(l)); renderPaginationControls();
    }

    function renderRow(lead) {
        const row = document.createElement("tr"); row.className = "hover:bg-indigo-50/30 transition-colors group animate-fade-in";
        row.innerHTML = `<td class="py-4 px-6"><div class="font-bold text-slate-900">${lead.nombre || "Sin Nombre"}</div></td><td class="py-4 px-6 text-sm text-slate-500">${lead.telefono || "N/A"}</td><td class="py-4 px-6 text-sm text-slate-500">${lead.email || "Sin Email"}</td><td class="py-4 px-6 text-xs text-slate-500 max-w-[200px] truncate">${lead.source || "N/A"}</td><td class="py-4 px-6 text-sm text-slate-500 whitespace-nowrap">${formatDate(lead.fecha)}</td><td class="py-4 px-6"><span class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded inline-block max-w-[150px] truncate text-ellipsis">${lead.estado || "Nuevo"}</span></td>`;
        tableBody.appendChild(row);
    }

    function updateStats(leads) {
        document.getElementById("stat-total-leads").innerText = leads.length.toLocaleString();
        const now = new Date();
        document.getElementById("stat-leads-today").innerText = leads.filter(l => l.fecha && new Date(l.fecha).toDateString() === now.toDateString()).length.toLocaleString();
        const d7 = new Date(); d7.setDate(now.getDate() - 7); d7.setHours(0, 0, 0, 0);
        document.getElementById("stat-last-7-days").innerText = leads.filter(l => l.fecha && new Date(l.fecha) >= d7).length.toLocaleString();
    }

    function handleSearch() {
        const q = searchInput.value.toLowerCase();
        filteredLeads = allLeads.filter(l => (l.nombre || "").toLowerCase().includes(q) || (l.email || "").toLowerCase().includes(q) || (l.telefono || "").toString().toLowerCase().includes(q));
        renderPage(1);
    }

    function renderPaginationControls() {
        const total = filteredLeads.length, pages = Math.ceil(total / ITEMS_PER_PAGE), start = (currentPage - 1) * ITEMS_PER_PAGE + 1, end = Math.min(currentPage * ITEMS_PER_PAGE, total);
        let b = `<button onclick="renderPage(${currentPage - 1})" class="px-3 py-1 rounded-lg border border-slate-200 text-xs font-bold text-slate-500 hover:bg-slate-50 disabled:opacity-50" ${currentPage === 1 ? 'disabled' : ''}>Anterior</button><span class="px-2 text-xs font-bold text-slate-600">P√°g ${currentPage}/${pages || 1}</span><button onclick="renderPage(${currentPage + 1})" class="px-3 py-1 rounded-lg border border-slate-200 text-xs font-bold text-slate-500 hover:bg-slate-50 disabled:opacity-50" ${currentPage === pages || pages === 0 ? 'disabled' : ''}>Siguiente</button>`;
        paginationContainer.innerHTML = `<span class="text-xs text-slate-400">${total > 0 ? start : 0}-${end} de ${total}</span><div class="flex gap-2 items-center">${b}</div>`;
    }

    function exportTableToCSV() {
        if (!allLeads.length) { alert("Sin datos"); return; }
        const csv = ["Nombre,Telefono,Correo,Servicio,Fecha_Hora,Estado", ...allLeads.map(l => `"${l.nombre || ''}","${l.telefono || ''}","${l.email || ''}","${l.source || ''}","${formatDate(l.fecha)}","${l.estado || ''}"`)].join("\n");
        const a = document.createElement("a"); a.href = encodeURI("data:text/csv;charset=utf-8," + csv); a.download = "export.csv"; a.click();
    }

    function formatDate(s) { if (!s) return "N/A"; try { const d = new Date(s); return !isNaN(d) ? `${d.getDate()} ${["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"][d.getMonth()]} ${d.getFullYear()}` : s } catch { return s } }
    function renderLoading() { tableBody.innerHTML = `<tr><td colspan="6" class="py-12 text-center text-slate-400">Cargando...</td></tr>` }
    function renderError(m) { tableBody.innerHTML = `<tr><td colspan="6" class="py-8 text-center text-red-500">${m}</td></tr>` }
    function renderEmpty() { tableBody.innerHTML = `<tr><td colspan="6" class="py-8 text-center text-slate-400">No hay leads.</td></tr>` }
</script>
<style>
    @keyframes f {
        from {
            opacity: 0;
            transform: translateY(5px)
        }

        to {
            opacity: 1;
            transform: translateY(0)
        }
    }

    .animate-fade-in {
        animation: f .3s ease-out forwards
    }
</style>